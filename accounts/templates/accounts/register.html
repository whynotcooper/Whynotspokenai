<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>英语口语网站 - 用户注册</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    body {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      display: flex;
      max-width: 1000px;
      width: 100%;
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }

    .left-section {
      flex: 1;
      background: linear-gradient(rgba(106, 17, 203, 0.8), rgba(37, 117, 252, 0.8)),
                  url('https://images.unsplash.com/photo-1541339907198-e08756dedf3f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
      background-size: cover;
      background-position: center;
      color: white;
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .left-section h1 { font-size: 2.5rem; margin-bottom: 20px; }
    .left-section p { font-size: 1.1rem; line-height: 1.6; }

    .right-section { flex: 1; padding: 40px; }

    .logo { text-align: center; margin-bottom: 26px; }
    .logo h2 { color: #2575fc; font-size: 2rem; }
    .logo p { color: #666; margin-top: 5px; }

    .messages {
      margin-bottom: 14px;
    }
    .msg {
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 0.9rem;
      border: 1px solid rgba(231, 76, 60, .35);
      background: rgba(231, 76, 60, .08);
      color: #c0392b;
      display: none;
      white-space: pre-wrap;
      line-height: 1.55;
    }
    .msg.show { display: block; }

    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
      background: #fff;
    }

    .form-control:focus {
      border-color: #2575fc;
      box-shadow: 0 0 0 2px rgba(37, 117, 252, 0.2);
      outline: none;
    }

    .help-text{
      margin-top: 6px;
      font-size: 12px;
      color: #888;
    }

    .error-message {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 6px;
      display: none;
      line-height: 1.35;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      color: white;
      border: none;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 6px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(37, 117, 252, 0.4);
    }

    .btn:disabled{
      opacity: .7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .login-link { text-align: center; margin-top: 18px; color: #666; }
    .login-link a { color: #2575fc; text-decoration: none; font-weight: 500; }
    .login-link a:hover { text-decoration: underline; }

    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .left-section { padding: 30px; }
      .right-section { padding: 30px 22px; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="left-section">
    <h1>加入英语口语社区</h1>
    <p>与全球英语学习者一起练习口语，提升您的英语交流能力。我们的平台提供专业的口语练习环境，让您自信地开口说英语。</p>
    <p style="margin-top: 20px;">注册后，您可以：</p>
    <ul style="margin-top: 10px; margin-left: 20px;">
      <li>与母语者进行一对一练习</li>
      <li>参加主题口语讨论小组</li>
      <li>获取专业发音指导</li>
      <li>记录您的口语进步历程</li>
    </ul>
  </div>

  <div class="right-section">
    <div class="logo">
      <h2>SpeakEasy</h2>
      <p>注册您的账户</p>
    </div>

    <!-- 顶部统一错误提示（后端返回 non_field_errors / 未知错误时显示） -->
    <div class="messages">
      <div class="msg" id="globalError"></div>
    </div>

    <form id="registerForm" method="post" action="{% url 'accounts:register' %}" novalidate>
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ next }}">

      <div class="form-group">
        <label for="username">用户名</label>
        <input type="text" name="username" id="username" class="form-control" placeholder="请输入用户名（字母/数字/下划线）" required>
        <div class="error-message" id="usernameError"></div>
      </div>

      <div class="form-group">
        <label for="phone">手机号</label>
        <input type="tel" name="phone" id="phone" class="form-control" placeholder="请输入手机号" required>
        <div class="error-message" id="phoneError"></div>
      </div>

      <!-- ✅ 必填：英语水平 -->
      <div class="form-group">
        <label for="english_level">英语水平</label>
        <select name="english_level" id="english_level" class="form-control" required>
          <option value="">请选择</option>
          <option value="beginner">初级</option>
          <option value="intermediate">中级</option>
          <option value="advanced">高级</option>
        </select>
        <div class="error-message" id="englishLevelError"></div>
      </div>

      <div class="form-group">
        <label for="password">密码（至少10位）</label>
        <input type="password" name="password" id="password" class="form-control" placeholder="请输入至少10位密码" required>
        <div class="help-text">建议：字母+数字组合，更安全。</div>
        <div class="error-message" id="passwordError"></div>
      </div>

      <!-- ✅ 必填：确认密码 -->
      <div class="form-group">
        <label for="password2">确认密码</label>
        <input type="password" name="password2" id="password2" class="form-control" placeholder="请再次输入密码" required>
        <div class="error-message" id="password2Error"></div>
      </div>

      <button type="submit" class="btn" id="submitBtn">注册</button>
    </form>

    <div class="login-link">
      已有账户？<a href="{% url 'accounts:login' %}?next={{ next|urlencode }}">立即登录</a>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById('registerForm');
  const submitBtn = document.getElementById('submitBtn');

  const globalError = document.getElementById('globalError');

  const usernameInput = document.getElementById('username');
  const phoneInput = document.getElementById('phone');
  const englishLevelSelect = document.getElementById('english_level');
  const passwordInput = document.getElementById('password');
  const password2Input = document.getElementById('password2');

  const usernameError = document.getElementById('usernameError');
  const phoneError = document.getElementById('phoneError');
  const englishLevelError = document.getElementById('englishLevelError');
  const passwordError = document.getElementById('passwordError');
  const password2Error = document.getElementById('password2Error');

  function showGlobalError(text){
    if (!text) {
      globalError.textContent = "";
      globalError.classList.remove("show");
      return;
    }
    globalError.textContent = text;
    globalError.classList.add("show");
  }

  function setFieldError(el, msg){
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  }

  function clearAllErrors(){
    showGlobalError("");
    setFieldError(usernameError, "");
    setFieldError(phoneError, "");
    setFieldError(englishLevelError, "");
    setFieldError(passwordError, "");
    setFieldError(password2Error, "");
  }

  // phone regex
  const phoneRegex = /^1[3-9]\d{9}$/;

  function clientValidate(){
    let ok = true;
    clearAllErrors();

    const username = usernameInput.value.trim();
    const phone = phoneInput.value.trim();
    const englishLevel = englishLevelSelect.value;
    const password = passwordInput.value;
    const password2 = password2Input.value;

    if (!username) { setFieldError(usernameError, "用户名不能为空"); ok = false; }
    if (!phoneRegex.test(phone)) { setFieldError(phoneError, "请输入有效的手机号"); ok = false; }
    if (!englishLevel) { setFieldError(englishLevelError, "请选择英语水平"); ok = false; }

    if (!password || password.length < 10) { setFieldError(passwordError, "密码长度至少为10位"); ok = false; }
    if (!password2) { setFieldError(password2Error, "请再次输入密码"); ok = false; }
    if (password && password2 && password !== password2) { setFieldError(password2Error, "两次密码不一致"); ok = false; }

    return ok;
  }

  // 输入时清掉错误提示
  [usernameInput, phoneInput, englishLevelSelect, passwordInput, password2Input].forEach(el => {
    el.addEventListener('input', () => {
      showGlobalError("");
      // 不做逐字段复杂判断，只要有输入就先隐藏
      if (el === usernameInput) setFieldError(usernameError, "");
      if (el === phoneInput) setFieldError(phoneError, "");
      if (el === passwordInput) setFieldError(passwordError, "");
      if (el === password2Input) setFieldError(password2Error, "");
    });
    el.addEventListener('change', () => {
      if (el === englishLevelSelect) setFieldError(englishLevelError, "");
    });
  });

  function applyServerErrors(payload){
    // payload: { errors: {field: [{message: "..."}]}, non_field_errors: [...] }
    if (!payload) return;

    // 非字段错误
    const nfe = payload.non_field_errors;
    if (nfe && nfe.length) {
      showGlobalError(Array.isArray(nfe) ? nfe.join("\n") : String(nfe));
    }

    const errors = payload.errors || {};
    const getMsg = (arr) => {
      if (!arr || !arr.length) return "";
      // 兼容 get_json_data() 结构
      if (typeof arr[0] === "string") return arr.join("\n");
      if (arr[0] && arr[0].message) return arr.map(x => x.message).join("\n");
      return String(arr);
    };

    if (errors.username) setFieldError(usernameError, getMsg(errors.username));
    if (errors.phone) setFieldError(phoneError, getMsg(errors.phone));
    if (errors.english_level) setFieldError(englishLevelError, getMsg(errors.english_level));
    if (errors.password) setFieldError(passwordError, getMsg(errors.password));
    if (errors.password2) setFieldError(password2Error, getMsg(errors.password2));

    // forms.ValidationError("...") 常出现 __all__
    if (errors.__all__) {
      const msg = getMsg(errors.__all__);
      if (msg) showGlobalError(msg);
    }
  }

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!clientValidate()) return;

    submitBtn.disabled = true;
    submitBtn.textContent = "注册中...";

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const nextUrl = (document.querySelector('input[name="next"]').value || '').trim();

    const username = usernameInput.value.trim();
    const phone = phoneInput.value.trim();
    const englishLevel = englishLevelSelect.value;
    const password = passwordInput.value;
    const password2 = password2Input.value;

    try {
      const res = await fetch("{% url 'accounts:register' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: new URLSearchParams({
          username: username,
          phone: phone,
          english_level: englishLevel,
          password: password,
          password2: password2,
          next: nextUrl
        })
      });

      const contentType = res.headers.get("content-type") || "";
      const data = contentType.includes("application/json")
        ? await res.json().catch(() => ({}))
        : {};

      if (!res.ok) {
        // 400/500 等，显示后端错误
        applyServerErrors(data);
        if (!data || !data.message) showGlobalError("注册失败，请检查输入信息。");
        return;
      }

      if (data.code === 200) {
        alert("注册成功！");
        const jump = (data.next || nextUrl || "{% url 'spoken_ai:index' %}");
        window.location.href = jump;
        return;
      }

      // 兼容：后端返回 ok:true
      if (data.ok === true) {
        const jump = (data.next || nextUrl || "{% url 'spoken_ai:index' %}");
        window.location.href = jump;
        return;
      }

      showGlobalError(data.message || "注册失败，请稍后重试");
    } catch (err) {
      console.error(err);
      showGlobalError("网络错误，请稍后重试。");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "注册";
    }
  });
</script>
</body>
</html>
