{% extends "base.html" %}

{% block title %}{{ profile_user.username }} · Profile{% endblock %}
{% block header_title %}用户档案{% endblock %}

{% block page_style %}
  .wrap{width:100%; max-width:1100px; padding: 0 24px 48px;}
  .profile-card{
    margin: 10px auto 18px;
    padding: 18px;
    border-radius: 18px;
    background: var(--card-bg);
    backdrop-filter: blur(var(--blur));
    box-shadow: var(--shadow);
    display:flex;
    gap:16px;
    align-items:center;
  }
  .avatar{
    width:72px; height:72px; border-radius:50%;
    background: linear-gradient(135deg,#6750a4,#9f7aea);
    overflow:hidden; flex:0 0 auto;
    display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:26px; font-weight:700;
  }
  .avatar img{width:100%; height:100%; object-fit:cover; display:block;}
  .p-info{flex:1;}
  .p-name{font-size:20px; font-weight:700; margin-bottom:4px;}
  .p-bio{opacity:.85; font-size:14px;}
  .actions{display:flex; gap:10px; flex-wrap:wrap;}
  .btn{
    padding:10px 14px; border-radius:999px; text-decoration:none;
    background: var(--card-bg); color: var(--text);
    border:1px solid rgba(103,80,164,.25);
    box-shadow: var(--shadow);
    cursor:pointer;
  }
  .btn.primary{background:linear-gradient(135deg,#6750a4,#9f7aea); color:#fff; border:none;}
  .btn.ghost{background:rgba(255,255,255,.25); border:1px solid rgba(103,80,164,.14);}

  /* 小红书瀑布流 */
  .masonry{column-count: 3; column-gap: 16px; margin-top: 16px;}
  @media(max-width: 980px){ .masonry{column-count:2;} }
  @media(max-width: 620px){ .masonry{column-count:1;} }

  .card{
    break-inside: avoid;
    margin: 0 0 16px;
    border-radius: 18px;
    background: var(--card-bg);
    backdrop-filter: blur(var(--blur));
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .cover{width:100%; display:block; aspect-ratio: 4/5; object-fit:cover; background: rgba(103,80,164,.15);}
  .card-body{padding: 12px 12px 14px;}
  .card-title{font-weight:700; margin-bottom:6px;}
  .card-text{font-size:13px; opacity:.85; line-height:1.45; white-space:pre-wrap;}

  /* ✅ 编辑弹窗 */
  .modal-mask{
    position:fixed; inset:0; background:rgba(0,0,0,.35);
    display:none; align-items:center; justify-content:center;
    z-index:9999; padding:16px;
  }
  .modal{
    width:min(520px, 92vw);
    background:var(--card-bg);
    border-radius:18px;
    box-shadow: var(--shadow);
    border:1px solid rgba(103,80,164,.15);
    padding:16px;
  }
  .modal-title{font-weight:800; font-size:16px; margin-bottom:12px;}
  .form-row{margin:10px 0;}
  .label{font-size:13px; opacity:.85; margin-bottom:6px;}
  .input, textarea{
    width:100%;
    border:none;
    border-radius:14px;
    padding:12px;
    background:rgba(255,255,255,.35);
    color: var(--text);
    outline:none;
    box-sizing:border-box;
  }
  textarea{resize:vertical; min-height:92px;}
  .modal-actions{display:flex; justify-content:flex-end; gap:10px; margin-top:14px;}

  .avatar-edit{
    display:flex; gap:12px; align-items:center;
  }
  .avatar-preview{
    width:64px; height:64px; border-radius:999px;
    overflow:hidden; border:1px solid rgba(103,80,164,.18);
    background:rgba(103,80,164,.12);
    flex:0 0 auto;
    cursor:pointer;            /* ✅ 可点击 */
  }
  .avatar-preview img{width:100%; height:100%; object-fit:cover; display:block;}
  .help{font-size:12px; opacity:.7; margin-top:6px;}
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="profile-card">
    <!-- ✅ 可选：点顶部头像也打开编辑弹窗 -->
    <div class="avatar" id="topAvatar">
      {% if profile_user.avatar %}
        <img src="{{ profile_user.avatar.url }}" alt="avatar">
      {% else %}
        {{ profile_user.username|first|default:"U" }}
      {% endif %}
    </div>

    <div class="p-info">
      <div class="p-name">
        {{ profile_ext.nickname|default:profile_user.username }}
      </div>
      <div class="p-bio">
        {{ profile_ext.bio|default:"这个人很懒，还没有写签名～" }}
      </div>
    </div>

    {% if is_owner %}
      <div class="actions">
        <a class="btn primary" href="{% url 'social:post_create' %}">发布图文</a>
        <button class="btn" id="editBtn" type="button">编辑资料</button>
      </div>
    {% endif %}
  </div>

  <div class="masonry">
    {% for post in posts %}
      {% include "social/_post_card.html" with post=post %}
    {% empty %}
      <div style="opacity:.8;">还没有发布任何帖子～</div>
    {% endfor %}
  </div>

</div>

{% if is_owner %}
<!-- ✅ Edit Modal -->
<div class="modal-mask" id="editMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-title">编辑资料</div>

    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="form-row">
        <div class="label">头像（点击左侧圆圈更换）</div>
        <div class="avatar-edit">
          <div class="avatar-preview" id="avatarPreviewBox" title="点击更换头像">
            {% if profile_user.avatar %}
              <img id="avatarPreview" src="{{ profile_user.avatar.url }}" alt="avatar">
            {% else %}
              <img id="avatarPreview" src="" alt="avatar" style="display:none;">
            {% endif %}
          </div>

          <div style="flex:1;">
            <!-- ✅ 隐藏的 file input（点击圆圈触发） -->
            {{ avatar_form.avatar }}

            <!-- ✅ 可选：按钮也能触发选择文件 -->
            <button type="button" class="btn" id="chooseAvatarBtn">选择图片</button>

            <div class="help">支持 JPG/PNG，建议正方形图片。</div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="label">昵称</div>
        {{ profile_form.nickname }}
      </div>

      <div class="form-row">
        <div class="label">个性签名</div>
        {{ profile_form.bio }}
      </div>

      <div class="modal-actions">
        <button class="btn ghost" id="cancelEdit" type="button">取消</button>
        <button class="btn primary" type="submit">保存</button>
      </div>
    </form>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if is_owner %}
<script>
  const editBtn = document.getElementById("editBtn");
  const editMask = document.getElementById("editMask");
  const cancelEdit = document.getElementById("cancelEdit");

  function openEdit() {
    editMask.style.display = "flex";
    editMask.setAttribute("aria-hidden", "false");
  }
  function closeEdit() {
    editMask.style.display = "none";
    editMask.setAttribute("aria-hidden", "true");
  }

  editBtn?.addEventListener("click", openEdit);
  cancelEdit?.addEventListener("click", closeEdit);
  editMask?.addEventListener("click", (e) => {
    if (e.target === editMask) closeEdit();
  });

  // ✅ 点击头像预览圈/按钮 => 触发文件选择
  const avatarInput = document.getElementById("avatarInput");
  const avatarPreview = document.getElementById("avatarPreview");
  const avatarPreviewBox = document.getElementById("avatarPreviewBox");
  const chooseAvatarBtn = document.getElementById("chooseAvatarBtn");

  function triggerChooseAvatar() {
    if (avatarInput) avatarInput.click();
  }

  avatarPreviewBox?.addEventListener("click", triggerChooseAvatar);
  chooseAvatarBtn?.addEventListener("click", triggerChooseAvatar);

  // ✅ 选择后立即预览
  avatarInput?.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    avatarPreview.src = url;
    avatarPreview.style.display = "block";
  });

  // ✅ 可选：点顶部头像也打开弹窗并选择文件
  const topAvatar = document.getElementById("topAvatar");
  topAvatar?.addEventListener("click", () => {
    openEdit();
    // 小延迟保证弹窗已显示
    setTimeout(triggerChooseAvatar, 50);
  });
</script>
<script>
  const avatarInput = document.getElementById("avatarInput");
  const avatarPreview = document.getElementById("avatarPreview");
  const avatarPreviewBox = document.querySelector(".avatar-preview");

  // 点击圆圈触发选择文件
  avatarPreviewBox?.addEventListener("click", () => {
    avatarInput?.click();
  });

  // 选择后预览
  avatarInput?.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    avatarPreview.src = url;
    avatarPreview.style.display = "block";
  });
</script>

{% endif %}
{% endblock %}
