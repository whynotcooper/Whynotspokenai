<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>Kimi å£è¯­æ•™ç»ƒ</title>

    <!-- ç²¾ç®€ normalize -->
    <style>
        /*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */
        html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:.67em 0}
    </style>

    <!-- å†…è”æ ·å¼ï¼šspoken_ai.css æ ¸å¿ƒ -->
    <style>
        :root{
            --bg:#ffffff;
            --bg-chat:#f2f2f7;
            --text:#000;
            --user:#007aff;
            --bot:#e5e5ea;
            --rec:#ff3b30;
        }
        [data-theme='dark']{
            --bg:#000;
            --bg-chat:#1c1c1e;
            --text:#fff;
            --user:#0a84ff;
            --bot:#3a3a3c;
        }
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,"PingFang SC",sans-serif;
            background:var(--bg);
            color:var(--text);
            transition:background .3s,color .3s;
            height:100vh;
            display:flex;
            flex-direction:column;
        }
        .header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:12px 16px;
            border-bottom:1px solid var(--bg-chat);
        }
        .header h1{font-size:20px;margin:0}
        .theme-btn{background:none;border:none;font-size:20px;cursor:pointer}

        .chat{flex:1;display:flex;flex-direction:column}
        .chat-box{
            flex:1;
            padding:12px;
            overflow-y:auto;
            background:var(--bg-chat);
        }
        .user-bubble,.bot-bubble{
            max-width:75%;
            padding:10px 14px;
            margin:6px 0;
            border-radius:18px;
            line-height:1.4;
            word-break:break-word;
        }
        .user-bubble{
            align-self:flex-end;
            background:var(--user);
            color:#fff;
        }
        .bot-bubble{
            align-self:flex-start;
            background:var(--bot);
            color:var(--text);
        }

        .recorder{
            padding:12px;
            display:flex;
            justify-content:center;
            border-top:1px solid var(--bg-chat);
        }
        .rec-btn{
            display:flex;
            align-items:center;
            gap:8px;
            padding:12px 24px;
            border:none;
            border-radius:24px;
            background:#007aff;
            color:#fff;
            font-size:16px;
            cursor:pointer;
            transition:background .2s;
        }
        .rec-btn.recording{background:var(--rec)}
        .mic{font-size:20px}
    </style>
</head>

<body>
<div class="app">
    <header class="header">
        <h1>Kimi å£è¯­æ•™ç»ƒ</h1>
        <button id="themeToggle" class="theme-btn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ—</button>
    </header>

    <main class="chat">
        <div id="chatBox" class="chat-box">
            <div class="bot-bubble">ä½ å¥½ï¼æŒ‰ä½ä¸‹æ–¹æŒ‰é’®å¼€å§‹å½•éŸ³ï¼Œæ¾å¼€åå³å¯è·å¾—åé¦ˆã€‚</div>
        </div>

        <!-- å½•éŸ³æŒ‰é’® -->
        <div class="recorder">
            <button id="recBtn" class="rec-btn">
                <span id="recIcon" class="mic">ğŸ¤</span>
                <span id="recText">æŒ‰ä½è¯´è¯</span>
            </button>
        </div>
    </main>
</div>

<!-- æ‰€æœ‰äº¤äº’è„šæœ¬ -->
<script>
/* ========== å·¥å…·å‡½æ•° ========== */
const chatBox = document.getElementById('chatBox');
const recBtn   = document.getElementById('recBtn');
const recIcon  = document.getElementById('recIcon');
const recText  = document.getElementById('recText');
const themeBtn = document.getElementById('themeToggle');

function addBubble(text, isUser = false) {
    const div = document.createElement('div');
    div.className = isUser ? 'user-bubble' : 'bot-bubble';
    div.textContent = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function typeWriter(el, text, speed = 40) {
    let i = 0;
    el.textContent = '';
    function type() {
        if (i < text.length) {
            el.textContent += text.charAt(i++);
            setTimeout(type, speed);
        }
    }
    type();
}

/* ========== ä¸»é¢˜åˆ‡æ¢ ========== */
themeBtn.addEventListener('click', () => {
    const html = document.documentElement;
    html.dataset.theme = html.dataset.theme === 'dark' ? '' : 'dark';
});

/* ========== å½•éŸ³é€»è¾‘ ========== */
let mediaRecorder, chunks;

/* å¼€å§‹å½•éŸ³ */
function startRecording(e) {
    e.preventDefault();
    if (!navigator.mediaDevices) {
        alert('æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³');
        return;
    }
    recBtn.classList.add('recording');
    recIcon.textContent = 'â¹ï¸';
    recText.textContent = 'æ¾å¼€å‘é€';

    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            const mime = MediaRecorder.isTypeSupported('audio/webm')
                       ? 'audio/webm'
                       : MediaRecorder.isTypeSupported('audio/mp4')
                       ? 'audio/mp4'
                       : '';
            mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : {});
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = sendAudio;
            mediaRecorder.start();
        })
        .catch(err => alert('éº¦å…‹é£æƒé™è·å–å¤±è´¥ï¼š' + err));
}

/* åœæ­¢å½•éŸ³ */
function stopRecording(e) {
    e.preventDefault();
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }
    recBtn.classList.remove('recording');
    recIcon.textContent = 'ğŸ¤';
    recText.textContent = 'æŒ‰ä½è¯´è¯';
}

/* ä¸Šä¼ å¹¶å¤„ç†éŸ³é¢‘ */
function sendAudio() {
    const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
    const ext  = mediaRecorder.mimeType.includes('webm') ? '.webm'
               : mediaRecorder.mimeType.includes('mp4') ? '.m4a' : '.wav';
    const form = new FormData();
    form.append('audio', blob, 'record' + ext);

    addBubble('æ­£åœ¨è¯†åˆ«...', false);

    fetch('/process_audio/', {
        method: 'POST',
        body: form,
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    })
    .then(r => r.json())
    .then(data => {
        chatBox.removeChild(chatBox.lastChild);   // ç§»é™¤â€œæ­£åœ¨è¯†åˆ«...â€
        if (data.error) {
            addBubble('è¯†åˆ«å¤±è´¥ï¼š' + data.error, false);
            return;
        }
        addBubble(data.transcription, true);

        const botDiv = document.createElement('div');
        botDiv.className = 'bot-bubble';
        chatBox.appendChild(botDiv);
        typeWriter(botDiv, data.feedback ?? '[æ— åé¦ˆ]');
    })
    .catch(err => {
        addBubble('è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•ï¼š' + err, false);
        console.error(err);
    });
}

/* äº‹ä»¶ç»‘å®š */
recBtn.addEventListener('mousedown', startRecording);
recBtn.addEventListener('touchstart', startRecording, { passive: true });
recBtn.addEventListener('mouseup', stopRecording);
recBtn.addEventListener('touchend', stopRecording);

/* ç®€æ˜“ CSRF token è·å–å‡½æ•° */
function getCookie(name) {
    let r = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return r ? decodeURIComponent(r[2]) : '';
}
</script>
</body>
</html>