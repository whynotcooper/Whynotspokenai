{% extends "base.html" %}

{% block title %}AI 口语教练 · 沉浸式首页{% endblock %}

{% block page_style %}
  /* 让首页整体居中排版（只影响首页） */
  body{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
  }

  /* 搜索框 */
  .search-box{
    position:relative;
    margin:16px 0 32px;
    width:clamp(300px,60vw,600px);
  }
  .search-box input{
    width:100%;
    padding:16px 52px 16px 20px;
    border-radius:var(--radius);
    border:none;
    background:var(--card-bg);
    color:var(--text);
    font-size:16px;
    backdrop-filter:blur(var(--blur));
    box-shadow:var(--shadow);
  }
  .search-box .icon{
    position:absolute;
    right:16px;
    top:50%;
    transform:translateY(-50%);
    color:var(--primary);
    cursor:pointer;
    font-size:24px;
  }
  .suggestion{
    position:absolute;
    top:100%;
    left:0;
    right:0;
    margin-top:4px;
    background:var(--card-bg);
    border-radius:var(--radius);
    backdrop-filter:blur(var(--blur));
    box-shadow:var(--shadow);
    overflow:hidden;
    display:none;
  }
  .suggestion li{
    padding:12px 20px;
    cursor:pointer;
    color:var(--text);
  }
  .suggestion li:hover{
    background:rgba(103,80,164,.15);
  }

  /* 卡片网格 */
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:32px;
    padding:0 48px 48px;
    width:100%;
    max-width:1200px;
  }
  .card{
    position:relative;
    height:200px;
    border-radius:var(--radius);
    background:var(--card-bg);
    color:var(--text);
    overflow:hidden;
    backdrop-filter:blur(var(--blur));
    box-shadow:var(--shadow);
    display:flex;
    align-items:flex-end;
    padding:24px;
    transition:transform .4s;
    text-decoration:none;
  }
  .card:hover{
    transform:rotateY(-5deg) scale(1.03);
  }
  .card .icon{
    font-size:48px;
    color:var(--primary);
    position:absolute;
    top:24px;
    left:24px;
  }
  .card h3{
    font-size:22px;
    font-weight:600;
    margin-bottom:4px;
  }
  .card p{
    font-size:14px;
    opacity:.8;
  }
  .card-bg{
    position:absolute;
    inset:0;
    border-radius:inherit;
    background:linear-gradient(135deg,var(--primary),#9f7aea);
    opacity:.15;
    transition:opacity .4s;
  }
  .card:hover .card-bg{
    opacity:.25;
  }
{% endblock %}

{% block content %}
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="搜索口语场景、功能或词汇…" autocomplete="off"/>
    <span class="icon material-symbols-rounded">search</span>
    <ul class="suggestion" id="suggestionBox"></ul>
  </div>

  <!-- ========= 功能卡片：全部要求登录后才能进入 ========= -->
  <section class="grid">
    <a class="card feature-link"
       href="{% url 'spoken_ai:toefl_index' %}"
       data-auth-required="true">
      <span class="icon material-symbols-rounded">record_voice_over</span>
      <div class="card-bg"></div>
      <div>
        <h3>托福口语</h3>
        <p>真题模考 · 计时练习 · AI 评分</p>
      </div>
    </a>

    <a class="card feature-link"
       href="{% url 'spoken_ai:spoken_ai' %}"
       data-auth-required="true">
      <span class="icon material-symbols-rounded">smart_toy</span>
      <div class="card-bg"></div>
      <div>
        <h3>AI 口语教练</h3>
        <p>实时纠错 · 发音评分 · 个性化训练</p>
      </div>
    </a>

    <a class="card feature-link"
       href="{% url 'spoken_ai:index' %}"
       data-auth-required="true">
      <span class="icon material-symbols-rounded">mic</span>
      <div class="card-bg"></div>
      <div>
        <h3>雅思口语</h3>
        <p>Part 1-3 全题库 · 考官 AI 模拟</p>
      </div>
    </a>

    <a class="card feature-link"
       href="{% url 'spoken_ai:index' %}"
       data-auth-required="true">
      <span class="icon material-symbols-rounded">forum</span>
      <div class="card-bg"></div>
      <div>
        <h3>学术交流</h3>
        <p>论文答辩 · 会议演讲 · 专业词汇</p>
      </div>
    </a>

    <!-- ✅ 论坛聊天：把当前用户名带过去（已 urlencode） -->
    <a class="card feature-link"
       href="{% url 'social:forum_home' %}{% if login_in %}?username={{ username|urlencode }}{% endif %}"
       data-auth-required="true">
      <span class="icon material-symbols-rounded">forum</span>
      <div class="card-bg"></div>
      <div>
        <h3>论坛聊天</h3>
        <p>进入房间 · 互助交流 · 一起练口语</p>
      </div>
    </a>

    <a class="card feature-link"
       href="{% url 'spoken_ai:index' %}"
       data-auth-required="true">
      <span class="icon material-symbols-rounded">emoji_emotions</span>
      <div class="card-bg"></div>
      <div>
        <h3>地道俚语</h3>
        <p>每日一句 · 场景例句 · 文化解读</p>
      </div>
    </a>
  </section>
{% endblock %}

{% block extra_js %}
<script>
  const isAuthenticated = window.IS_AUTHENTICATED; // base 里已经写好了

  /* 1. 搜索联想 */
  const keywords = ["托福口语 Task 1", "雅思 Part 2 话题卡", "AI 纠音", "地道俚语", "旅游对话", "学术交流场景"];
  const searchInput = document.getElementById('searchInput');
  const suggestionBox = document.getElementById('suggestionBox');

  if (searchInput && suggestionBox) {
    searchInput.addEventListener('input', () => {
      const val = searchInput.value.toLowerCase();
      suggestionBox.innerHTML = '';
      if (!val) { suggestionBox.style.display = 'none'; return; }
      const matches = keywords.filter(k => k.toLowerCase().includes(val));
      if (matches.length) {
        matches.forEach(m => {
          const li = document.createElement('li');
          li.textContent = m;
          li.addEventListener('click', () => {
            searchInput.value = m;
            suggestionBox.style.display = 'none';
          });
          suggestionBox.appendChild(li);
        });
        suggestionBox.style.display = 'block';
      } else {
        suggestionBox.style.display = 'none';
      }
    });

    document.addEventListener('click', e => {
      if (!e.target.closest('.search-box')) suggestionBox.style.display = 'none';
    });
  }

  /* 2. 功能卡片：必须登录后才能跳转（弹窗 DOM 在 base 里） */
  const featureLinks = document.querySelectorAll('.feature-link[data-auth-required="true"]');
  const authModalBackdrop = document.getElementById('authModalBackdrop');
  const modalCancelBtn = document.getElementById('modalCancelBtn');

  function showAuthModal() {
    if (authModalBackdrop) authModalBackdrop.style.display = 'flex';
  }
  function closeAuthModal() {
    if (authModalBackdrop) authModalBackdrop.style.display = 'none';
  }

  featureLinks.forEach(link => {
    link.addEventListener('click', function (e) {
      if (!isAuthenticated) {
        e.preventDefault();
        showAuthModal();
      }
    });
  });

  modalCancelBtn?.addEventListener('click', closeAuthModal);
  authModalBackdrop?.addEventListener('click', (e) => {
    if (e.target === authModalBackdrop) closeAuthModal();
  });
</script>
{% endblock %}
