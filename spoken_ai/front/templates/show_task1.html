<!-- templates/show_task1.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{{ task.name }}</title>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; margin: 40px; line-height: 1.6; }
        h1 { color: #2980b9; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section { margin: 25px 0; }
        .section h2 {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 8px;
        }
        .section p, .section textarea {
            background: #f9f9f9;
            padding: 12px;
            border-left: 4px solid #3498db;
            white-space: pre-wrap;
            word-wrap: break-word;
            width: 100%;
            box-sizing: border-box;
        }
        textarea {
            border: 1px solid #ccc;
            resize: vertical;
            min-height: 100px;
        }
        .hidden { display: none; }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover { background: #2980b9; }
        .btn-secondary { background: #7f8c8d; }
        .btn-secondary:hover { background: #95a5a6; }
        .timer { font-weight: bold; color: #e74c3c; }
        .back {
            display: inline-block;
            margin-top: 20px;
            color: #7f8c8d;
            text-decoration: none;
        }
        .back:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>{{ task.name }}</h1>

    <!-- 1. é¢˜ç›®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
    <div class="section">
        <h2>é˜…è¯»æ–‡æœ¬</h2>
        <p>{{ task.readingtext|default:"æ— " }}</p>
    </div>

    <!-- 2. å½•éŸ³åŒºåŸŸ -->
    <div class="section" id="recordSection">
        <h2>è¯·å›ç­”ï¼ˆ45ç§’ï¼‰</h2>
        <p>ç‚¹å‡»â€œå¼€å§‹å½•éŸ³â€åï¼Œä½ æœ‰ 45 ç§’æ—¶é—´å›ç­”ã€‚</p>
        <button id="startBtn" class="btn">å¼€å§‹å½•éŸ³</button>
        <span id="timer" class="timer hidden">å‰©ä½™: <span id="countdown">45</span> ç§’</span>
        <button id="stopBtn" class="btn btn-secondary hidden">æå‰ç»“æŸ</button>
        <div id="recordStatus" style="margin-top: 10px;"></div>
    </div>

    <!-- 3. è½¬å†™æ–‡æœ¬ç¼–è¾‘åŒºï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div class="section hidden" id="editSection">
        <h2>ä½ çš„å›ç­”ï¼ˆå¯ç¼–è¾‘ï¼‰</h2>
        <textarea id="transcriptionText" placeholder="è¯­éŸ³è½¬å†™ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        <br>
        <button id="confirmBtn" class="btn">ç¡®è®¤æœ€ç»ˆç­”æ¡ˆå¹¶ç”ŸæˆæŠ¥å‘Š</button>
    </div>

    <!-- 4. AI åé¦ˆ + PDF ä¸‹è½½ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div class="section hidden" id="feedbackSection">
        <h2>AI è¯„åˆ†æŠ¥å‘Š</h2>
        <div id="feedbackContent"></div>
        <br>
        <a id="pdfLink" target="_blank" style="display:none;">ğŸ“¥ ä¸‹è½½ PDF æŠ¥å‘Š</a>
    </div>

    <!-- 5. æ˜¾ç¤ºå‚è€ƒç­”æ¡ˆæŒ‰é’® -->
    <div class="section">
        <button id="showAnswersBtn" class="btn btn-secondary">æ˜¾ç¤ºå‚è€ƒç­”æ¡ˆä¸è§£é¢˜æ€è·¯</button>
    </div>

    <!-- 6. å‚è€ƒç­”æ¡ˆåŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div class="section hidden" id="answersSection">
        <h2>å‚è€ƒç­”æ¡ˆ1</h2>
        <p>{{ task.answertext1 }}</p>
        <h2>å‚è€ƒç­”æ¡ˆ2</h2>
        <p>{{ task.answertext2 }}</p>
        <h2>è§£é¢˜æ€è·¯</h2>
        <p>{{ task.reasontext }}</p>
    </div>

    <a href="{% url 'spoken_ai:task1_list' %}" class="back">â† è¿”å›ä»»åŠ¡åˆ—è¡¨</a>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let countdownInterval = null;
        const task_id = {{ task.id }};

        document.getElementById('startBtn').addEventListener('click', startRecording);
        document.getElementById('stopBtn').addEventListener('click', stopRecording);
        document.getElementById('confirmBtn').addEventListener('click', confirmAnswer);
        document.getElementById('showAnswersBtn').addEventListener('click', showAnswers);

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        uploadAudio(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    document.getElementById('startBtn').classList.add('hidden');
                    document.getElementById('timer').classList.remove('hidden');
                    document.getElementById('stopBtn').classList.remove('hidden');
                    document.getElementById('recordStatus').innerText = 'æ­£åœ¨å½•éŸ³...';

                    // 45ç§’å€’è®¡æ—¶
                    let timeLeft = 45;
                    document.getElementById('countdown').innerText = timeLeft;
                    countdownInterval = setInterval(() => {
                        timeLeft--;
                        document.getElementById('countdown').innerText = timeLeft;
                        if (timeLeft <= 0) {
                            stopRecording();
                        }
                    }, 1000);
                })
                .catch(err => {
                    document.getElementById('recordStatus').innerText = 'å½•éŸ³å¤±è´¥: ' + err.message;
                });
        }

        function stopRecording() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        function uploadAudio(blob) {
            const formData = new FormData();
            formData.append('audio', blob, 'answer.webm');
        
            fetch(`process_task_audio/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('transcriptionText').value = data.transcription;
                    document.getElementById('editSection').classList.remove('hidden');
                    document.getElementById('recordSection').classList.add('hidden');
                } else {
                    alert('è¯­éŸ³å¤„ç†å¤±è´¥: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert('ä¸Šä¼ å¤±è´¥');
            });
        }

        function confirmAnswer() {
            const finalText = document.getElementById('transcriptionText').value.trim();
            if (!finalText) {
                alert('è¯·è¾“å…¥ä½ çš„å›ç­”');
                return;
            }

            fetch(`analyse_task1/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ student_answer: finalText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ˜¾ç¤ºåé¦ˆ
                    let html = `<p><strong>è¯„åˆ†:</strong> ${data.feedback.score || 'N/A'}</p>`;
                    html += `<p><strong>é—®é¢˜:</strong> ${data.feedback.issues || ''}</p>`;
                    html += `<p><strong>å»ºè®®:</strong> ${data.feedback.reason || ''}</p>`;
                    if (data.feedback.phrases) {
                        html += `<p><strong>æ¨èçŸ­è¯­:</strong> ${data.feedback.phrases.join(', ')}</p>`;
                    }
                    document.getElementById('feedbackContent').innerHTML = html;

                    // æ˜¾ç¤º PDF é“¾æ¥
                    if (data.pdf_url) {
                        const link = document.getElementById('pdfLink');
                        link.href = data.pdf_url;
                        link.style.display = 'inline';
                    }

                    document.getElementById('feedbackSection').classList.remove('hidden');
                } else {
                    alert('åˆ†æå¤±è´¥: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert('æäº¤å¤±è´¥');
            });
        }

        function showAnswers() {
            document.getElementById('answersSection').classList.remove('hidden');
            document.getElementById('showAnswersBtn').classList.add('hidden');
        }
    </script>
</body>
</html>